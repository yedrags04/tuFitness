import { fetch } from "@libsql/isomorphic-fetch";
import { Client } from "../client.js";
import { ClosedError } from "../errors.js";
import { HttpStream } from "./stream.js";
/** A client for the Hrana protocol over HTTP. */
export class HttpClient extends Client {
    #url;
    #jwt;
    #fetch;
    #closed;
    #streams;
    /** @private */
    constructor(url, jwt, customFetch) {
        super();
        this.#url = url;
        this.#jwt = jwt;
        this.#fetch = customFetch ?? fetch;
        this.#closed = false;
        this.#streams = new Set();
    }
    /** Get the protocol version supported by the server. */
    getVersion() {
        return Promise.resolve(2);
    }
    /** Open a {@link HttpStream}, a stream for executing SQL statements. */
    openStream() {
        if (this.#closed) {
            throw new ClosedError("Client is closed", undefined);
        }
        const stream = new HttpStream(this, this.#url, this.#jwt, this.#fetch);
        this.#streams.add(stream);
        return stream;
    }
    /** @private */
    _streamClosed(stream) {
        this.#streams.delete(stream);
    }
    /** Close the client and all its streams. */
    close() {
        this.#closed = true;
        for (const stream of Array.from(this.#streams)) {
            stream._closeFromClient();
        }
    }
    /** True if the client is closed. */
    get closed() {
        return this.#closed;
    }
}
